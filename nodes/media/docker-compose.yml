version: "3.9"

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: media-jellyfin
    restart: unless-stopped
    
    network_mode: host
    
    environment:
      PUID: "${PUID}"
      PGID: "${PGID}"
      TZ: "${TZ}"
    
    volumes:
      - ${JELLYFIN_CONFIG_DIR}:/config
      - ${JELLYFIN_CACHE_DIR}:/cache
      - ${NFS_MOUNT_MEDIA}/movies:/media/movies:ro
      - ${NFS_MOUNT_MEDIA}/tv:/media/tv:ro
      - ${NFS_MOUNT_MEDIA}/music:/media/music:ro
    
    # Uncomment for Intel QuickSync
    # devices:
    #   - /dev/dri:/dev/dri
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: media-vaultwarden
    restart: unless-stopped
    
    network_mode: host
    
    environment:
      DOMAIN: "${VAULTWARDEN_DOMAIN}"
      SIGNUPS_ALLOWED: "${VAULTWARDEN_SIGNUPS_ALLOWED}"
      ADMIN_TOKEN: "${VAULTWARDEN_ADMIN_TOKEN}"
      TZ: "${TZ}"
    
    volumes:
      - ${VAULTWARDEN_DATA_DIR}:/data
    
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/alive"]
      interval: 30s
      timeout: 5s
      retries: 3

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: media-uptime-kuma
    restart: unless-stopped
    
    network_mode: host
    
    environment:
      TZ: "${TZ}"
    
    volumes:
      - ${UPTIME_KUMA_DATA_DIR}:/app/data
    
    healthcheck:
      test: ["CMD", "node", "extra/healthcheck.js"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  grafana:
    image: grafana/grafana:latest
    container_name: media-grafana
    restart: unless-stopped
    
    network_mode: host
    
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
      GF_SERVER_ROOT_URL: "https://grafana.homelab.com"
      TZ: "${TZ}"
    
    volumes:
      - ${GRAFANA_DATA_DIR}:/var/lib/grafana
    
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  node-exporter:
    image: prom/node-exporter:latest
    container_name: media-node-exporter
    restart: unless-stopped
    
    network_mode: host
    pid: host
    
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"