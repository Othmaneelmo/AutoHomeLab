version: "3.9"

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped

    ports:
      - "${JELLYFIN_PORT}:8096"
      # Optional: DLNA discovery
      # - "1900:1900/udp"
      # - "7359:7359/udp"

    environment:
      PUID: "${PUID}"
      PGID: "${PGID}"
      TZ: "${TZ}"

    volumes:
      # Configuration and metadata
      - "${JELLYFIN_CONFIG_DIR}:/config"
      - "${JELLYFIN_CACHE_DIR}:/cache"
      
      # Media libraries (read-only for safety)
      - "${MEDIA_MOVIES}:/media/movies:ro"
      - "${MEDIA_TV}:/media/tv:ro"
      - "${MEDIA_MUSIC}:/media/music:ro"

    # Hardware transcoding (Intel QuickSync example)
    # Uncomment if you have Intel CPU with QuickSync
    # devices:
    #   - /dev/dri:/dev/dri

    # NVIDIA GPU example (requires nvidia-container-toolkit)
    # Uncomment if you have NVIDIA GPU
    # runtime: nvidia
    # environment:
    #   NVIDIA_VISIBLE_DEVICES: all
    #   NVIDIA_DRIVER_CAPABILITIES: all

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s